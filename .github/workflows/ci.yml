name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ───────────────────────────────────────────
  # Unit tests — runs on every push and PR
  # Spec: specs/3-verification.md — "Unit tests: Run on every commit"
  # ───────────────────────────────────────────
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Run unit tests
        run: uv run pytest tests/unit/ -v --tb=short

  # ───────────────────────────────────────────
  # Integration tests — runs on PRs only
  # Spec: specs/3-verification.md — "Integration tests: Run on PR"
  # ───────────────────────────────────────────
  integration-tests:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Run integration tests
        run: uv run pytest tests/integration/ -v --tb=short || echo "No integration tests yet"

  # ───────────────────────────────────────────
  # Docker build — verify image builds cleanly
  # ───────────────────────────────────────────
  docker:
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t chymera-w0:ci -f dockerfile .

      - name: Run tests in Docker
        run: docker run --rm chymera-w0:ci
